<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.5">
    <title>–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='index.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='calendar.css') }}">
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.0/main.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.0/main.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.0/locales/ru.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
<header>
    <h1>GoalPlan</h1>
</header>

<div class="content">
    {% if current_user.is_authenticated %}
        <div class="user-profile">
            <h2>–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
            <p><strong>–ò–º—è:</strong> {{ current_user.name }}</p>
            <p><strong>Email:</strong> {{ current_user.email }}</p>
            <form action="{{ url_for('logout') }}" method="POST">
                <button type="submit" class="button logout-button">–í—ã–π—Ç–∏</button>
            </form>
        </div>

        <a href="{{ url_for('create_board') }}" class="button create-board-button">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –¥–æ—Å–∫—É</a>

    {% else %}
        <a href="{{ url_for('login') }}" class="button">–í–æ–π—Ç–∏</a>
        <a href="{{ url_for('register') }}" class="button">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a>
    {% endif %}

    <h2>–î–æ—Å–∫–∏</h2>
    <div class="board-list">
        {% for board in boards %}
            <div class="board-container">
                <a href="{{ url_for('board', board_id=board.id) }}" class="board-name">{{ board.name }}</a>
                <form action="{{ url_for('delete_board', board_id=board.id) }}" method="POST" class="delete-board-form">
                    <button type="submit" class="delete-button">üóë</button>
                </form>
            </div>
        {% else %}
            <p>–£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å–æ–∫. –°–æ–∑–¥–∞–π—Ç–µ –æ–¥–Ω—É!</p>
        {% endfor %}
    </div>

    <h2>–ö–∞–ª–µ–Ω–¥–∞—Ä—å –¥–µ–¥–ª–∞–π–Ω–æ–≤</h2>
    <div id="calendar"></div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        var calendarEl = document.getElementById('calendar');

        var calendar = new FullCalendar.Calendar(calendarEl, {
            locale: 'ru',
            initialView: 'dayGridMonth',
            events: [
                {% for board in boards %}
                    {% for list in board.lists %}
                        {% for card in list.cards %}
                            {% if card.due_date %}
                                {
                                    title: "{{ card.title }}",
                                    start: "{{ card.due_date.strftime('%Y-%m-%dT%H:%M:%S') }}",
                                    description: "{{ card.description }}",
                                    url: "{{ url_for('card', card_id=card.id) }}",
                                    id: "{{ card.id }}"
                                },
                            {% endif %}
                        {% endfor %}
                    {% endfor %}
                {% endfor %}
            ],
            eventClick: function(info) {
                Swal.fire({
                    title: '–í—ã —É–≤–µ—Ä–µ–Ω—ã?',
                    text: "–í—ã —Ö–æ—Ç–∏—Ç–µ –ø–µ—Ä–µ–π—Ç–∏ –∫ –∫–∞—Ä—Ç–æ—á–∫–µ?",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: '–î–∞, –ø–µ—Ä–µ–π—Ç–∏!',
                    cancelButtonText: '–û—Ç–º–µ–Ω–∞'
                }).then((result) => {
                    if (result.isConfirmed) {
                        window.location.href = info.event.url;
                    }
                });
            },
            editable: true,
            droppable: true,
            eventColor: '#378006',
            eventDrop: function(info) {
                var event = info.event;
                var cardId = event.id;
                var newDate = event.startStr;

                fetch('/update_card_date', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        card_id: cardId,
                        new_date: newDate
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        Toastify({
                            text: "–î–∞—Ç–∞ –∫–∞—Ä—Ç–æ—á–∫–∏ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!",
                            backgroundColor: "green",
                            duration: 3000
                        }).showToast();
                    } else {
                        Toastify({
                            text: "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–∞—Ç—ã.",
                            backgroundColor: "red",
                            duration: 3000
                        }).showToast();
                    }
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞:', error);
                    Toastify({
                        text: "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞.",
                        backgroundColor: "red",
                        duration: 3000
                    }).showToast();
                });
            }
        });

        calendar.render();

        document.querySelectorAll('.delete-board-form').forEach(function(form) {
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                Swal.fire({
                    title: '–í—ã —É–≤–µ—Ä–µ–Ω—ã?',
                    text: "–≠—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç–º–µ–Ω–µ–Ω–∞!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: '–î–∞, —É–¥–∞–ª–∏—Ç—å!',
                    cancelButtonText: '–û—Ç–º–µ–Ω–∞'
                }).then((result) => {
                    if (result.isConfirmed) {
                        this.submit();
                    }
                });
            });
        });
    });
</script>

<script src="{{ url_for('static', filename='js/dark-mode.js') }}"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const toggleButton = document.getElementById("dark-mode-toggle");

        if (typeof(Storage) !== "undefined") {
            const isDarkMode = localStorage.getItem("dark-mode") === "enabled";

            if (isDarkMode) {
                document.body.classList.add("dark-mode");
                document.documentElement.style.setProperty("--background-color", "#121212");
                document.documentElement.style.setProperty("--text-color", "#ffffff");
                toggleButton.textContent = "–°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞";
            }

            toggleButton.addEventListener("click", function () {
                document.body.classList.toggle("dark-mode");

                if (document.body.classList.contains("dark-mode")) {
                    localStorage.setItem("dark-mode", "enabled");
                    document.documentElement.style.setProperty("--background-color", "#121212");
                    document.documentElement.style.setProperty("--text-color", "#ffffff");
                    toggleButton.textContent = "–°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞";
                } else {
                    localStorage.setItem("dark-mode", "disabled");
                    document.documentElement.style.setProperty("--background-color", "#ffffff");
                    document.documentElement.style.setProperty("--text-color", "#000000");
                    toggleButton.textContent = "–¢–µ–º–Ω–∞—è —Ç–µ–º–∞";
                }
            });
        } else {
            console.error("localStorage –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ.");
        }
    });
</script>

{% include 'footer.html' %}
